<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mishuba Live Broadcaster Console</title>
<style>
    body { font-family: Arial; padding: 20px; }
    video { width: 60%; border: 1px solid #ccc; }
    #log {
        width: 80%;
        height: 200px;
        background: #111;
        color: #0f0;
        padding: 10px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
    }
</style>
</head>
<body>

<h2>Webcam Streaming Control</h2>

<label>Stream Key:</label><br>
<input id="streamKey" type="text" style="width:300px;"><br><br>

<label>Role:</label><br>
<select id="role" style="width:200px;">
    <option value="broadcaster">broadcaster</option>
    <option value="audio_only">audio_only</option>
</select><br><br>

<button id="startBtn">Start Stream</button>
<button id="stopBtn" disabled>Stop Stream</button>

<hr>

<video id="cam" autoplay playsinline></video>

<hr>

<h3>Log</h3>
<div id="log"></div>

<script>
let ws = null;
let recorder = null;
let stream = null;
let reconnectTimer = null;

function log(msg) {
    const logBox = document.getElementById("log");
    logBox.innerText += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
}

// ---------------------- WebSocket ----------------------
async function connectWS(key, role) {
    const wsUrl = `ws://world.tsunamiflow.club/ws?key=${encodeURIComponent(key)}&role=${encodeURIComponent(role)}`;
    ws = new WebSocket(wsUrl);
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
        log("ðŸŒ WebSocket connected.");
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
        if (reconnectTimer) clearTimeout(reconnectTimer);
    };

    ws.onclose = () => {
        log("âš ï¸ WebSocket closed, falling back to RTMP...");
        startFallbackRTMP(stream, key);
    };

    ws.onerror = (err) => {
        log("âŒ WebSocket error: " + err);
        if (err instanceof Event) log("Event Type: " + err.type);
    };

    ws.onmessage = event => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === "ffmpeg_stderr") log("[FFmpeg] " + data.message);
        } catch {
            // ignore non-JSON
        }
    };
}

// ---------------------- Fallback RTMP ----------------------
function startFallbackRTMP(localStream, key) {
    if (!localStream) { log("âŒ No media stream available for RTMP fallback."); return; }
    log("ðŸš¨ Using RTMP fallback...");

    recorder = new MediaRecorder(localStream, { mimeType: "video/webm; codecs=vp8" });
    recorder.ondataavailable = async e => {
        if (e.data.size > 0) {
            const form = new FormData();
            form.append('key', key);
            form.append('chunk', e.data);

            fetch('world.tsunamiflow.club/TfRTMP.php', { method: 'POST', body: form })
                .then(r => log("ðŸ“¡ Chunk sent to RTMP server"))
                .catch(err => log("âŒ Failed to send chunk: " + err));
        }
    };
    recorder.start(100);
}

// ---------------------- Button Events ----------------------
document.getElementById("startBtn").onclick = async function () {
    const key = document.getElementById("streamKey").value.trim();
    const role = document.getElementById("role").value;
    if (!key) { alert("Enter a stream key."); return; }

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: role !== "audio_only",
            audio: true
        });
        document.getElementById("cam").srcObject = stream;
    } catch (err) {
        log("âŒ Failed to access camera/mic: " + err);
        return;
    }

    // Try WebSocket first
    try { await connectWS(key, role); }
    catch (err) {
        log("âš ï¸ WebSocket failed, falling back to RTMP: " + err);
        startFallbackRTMP(stream, key);
    }
};

document.getElementById("stopBtn").onclick = function () {
    if (recorder) { recorder.stop(); log("ðŸ›‘ Recorder stopped."); }
    if (ws && ws.readyState === 1) { ws.send(JSON.stringify({ type: "stop_stream" })); ws.close(); }
    if (stream) { stream.getTracks().forEach(t => t.stop()); log("ðŸ“· Camera stopped."); }

    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
};
</script>
</body>
</html>