<!DOCTYPE html>
<html>
<body>
<video id="cam" autoplay playsinline></video>

<script>
const ws = new WebSocket("wss://world.tsunamiflow.club:8443"); // your Ratchet server
const video = document.getElementById("cam");

navigator.mediaDevices.getUserMedia({ video: true, audio: false })
  .then(stream => {
    video.srcObject = stream;
    startSending(stream);
  })
  .catch(err => console.error("Camera error:", err));

function startSending(stream) {
  const track = stream.getVideoTracks()[0];
  const imageCapture = new ImageCapture(track);

  async function loop() {
    try {
      const bitmap = await imageCapture.grabFrame();
      const canvas = new OffscreenCanvas(bitmap.width, bitmap.height);
      const ctx = canvas.getContext("2d");
      ctx.drawImage(bitmap, 0, 0);
      const blob = await canvas.convertToBlob({ type: "image/jpeg", quality: 0.7 });
      ws.send(await blob.arrayBuffer());
    } catch (e) {
      console.error(e);
    }
    requestAnimationFrame(loop);
  }

  loop();
}
</script>
</body>
</html>