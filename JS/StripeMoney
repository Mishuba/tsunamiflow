class StripeDonation {
    constructor(stripePublicKey, backendUrl = "https://world.tsunamiflow.club/stripeBackend.php") {
        this.stripe = Stripe(stripePublicKey);
        this.backendUrl = backendUrl;
        this.cardElement = null;
    }

    // Generic XMLHttpRequest helper returning a Promise
    request(data) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", this.backendUrl, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.withCredentials = true; // Required if backend sends credentials

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status === 200 && !response.error) resolve(response);
                        else reject(response.error || 'Unknown error');
                    } catch (err) {
                        reject(err.message || 'JSON parse error');
                    }
                }
            };

            xhr.send(JSON.stringify(data));
        });
    }

    // Mount Stripe Card Element
    mountCard(elementId) {
        const elements = this.stripe.elements();
        this.cardElement = elements.create('card');
        this.cardElement.mount(`#${elementId}`);
    }

    // One-time donation (PaymentIntent)
    async donate(amount, currency = 'usd') {
        if (!this.cardElement) throw new Error("Card element not mounted");

        const data = await this.request({
            action: 'createPaymentIntent',
            amount: Math.round(amount * 100), // convert dollars to cents
            currency
        });

        const { clientSecret } = data;
        return this.stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: this.cardElement }
        });
    }

    // Subscription (Setup + PaymentIntent)
    async subscribe(email, priceId) {
        if (!this.cardElement) throw new Error("Card element not mounted");

        const data = await this.request({
            action: 'createSubscription',
            email,
            priceId
        });

        const { clientSecret } = data;

        if (!clientSecret) {
            // No payment required (free trial / free plan)
            return { status: 'success', message: 'No payment required' };
        }

        return this.stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: this.cardElement }
        });
    }

    // Generic client secret fetch
    getClientSecret(action, data) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", this.backendUrl, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.withCredentials = true;

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status === 200 && !response.error) resolve(response.clientSecret);
                        else reject(response.error || 'Unknown error');
                    } catch (err) {
                        reject(err.message || 'JSON parse error');
                    }
                }
            };

            xhr.send(JSON.stringify({ action, ...data }));
        });
    }
}