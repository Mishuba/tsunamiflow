class StripeDonation {
    constructor(stripePublicKey) {
        this.stripe = Stripe(stripePublicKey);
        this.backendUrl = "https://world.tsunamiflow.club/StripeStuff.php";
    }

    request(data) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", this.backendUrl, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status === 200) resolve(response);
                        else reject(response);
                    } catch (err) {
                        reject(err);
                    }
                }
            };
            xhr.send(JSON.stringify(data));
        });
    }

    async donate(amount, currency = 'usd') {
        const data = await this.request({
            action: 'createPaymentIntent',
            amount: Math.round(amount * 100), // convert dollars to cents
            currency
        });

        const { clientSecret } = data;
        return this.stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: this.cardElement
            }
        });
    }

    async subscribe(email, priceId) {
        const data = await this.request({
            action: 'createSubscription',
            email,
            priceId
        });

        const { clientSecret } = data;
        return this.stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: this.cardElement
            }
        });
    }

    mountCard(elementId) {
        const elements = this.stripe.elements();
        this.cardElement = elements.create('card');
        this.cardElement.mount(`#${elementId}`);
    }
getClientSecret(action, data, callback) {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "https://world.tsunamiflow.club/stripeBackend.php", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.withCredentials = true; // Required if backend sends Access-Control-Allow-Credentials

    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (xhr.status === 200 && !response.error) {
                    callback(null, response.clientSecret);
                } else {
                    callback(response.error || 'Unknown error');
                }
            } catch (err) {
                callback(err.message || 'JSON parse error');
            }
        }
    };

    const payload = { action, ...data };
    xhr.send(JSON.stringify(payload));
}
}